{
    admin off
    persist_config off
    auto_https off

    # REQUIRED: This tells Caddy in what order to process the new modules
    order rate_limit before reverse_proxy
    order maxmind_geolocation before respond

    # Runtime logs
    log {
        format json
    }

    # Server options
    servers {
        # Trust Railway's proxy to ensure {remote_host} is the actual user IP, not Railway's internal IP
        trusted_proxies static private_ranges
    }
}

(lb_settings) {
    lb_policy round_robin
    lb_retries 100
    lb_try_duration 10s
    lb_try_interval 250ms
}

(passive_health_checks) {
    fail_duration 60s
    max_fails 300
    unhealthy_latency 5s
    unhealthy_request_count 200
}

# Site block listens on $PORT (assigned by Railway)
:{$PORT} {
    # Access logs
    log {
        format json
    }

    # 1. IP RESTRICTION (SCANDINAVIA ONLY)
    # Matches users NOT in DK, NO, SE, FI, or IS
    @not_scandinavia {
        not maxmind_geolocation {
            db_path "/app/GeoLite2-Country.mmdb"
            allow_countries DK NO SE FI IS
        }
    }
    respond @not_scandinavia "Access restricted to Scandinavia." 403

    # 2. RATE LIMITING
    # Prevents abuse by limiting each unique IP address
    rate_limit {
        zone general_limit {
            key {remote_host}
            window 1s
            events 10
            burst 20
        }
    }

    # 3. ROUTING LOGIC

    # OAuth2 paths
    handle /oauth2/* {
        reverse_proxy {
            dynamic a {
                name {$BACKEND_DOMAIN}
                port {$BACKEND_PORT}
                refresh 1s
                dial_timeout 30s
                versions ipv4 ipv6
            }
            import lb_settings
            import passive_health_checks
            header_up Host {upstream_hostport}
        }
    }

    # OAuth2 callback
    handle /login/oauth2/* {
        reverse_proxy {
            dynamic a {
                name {$BACKEND_DOMAIN}
                port {$BACKEND_PORT}
                refresh 1s
                dial_timeout 30s
                versions ipv4 ipv6
            }
            import lb_settings
            import passive_health_checks
            header_up Host {upstream_hostport}
        }
    }

    # Backend API handling
    handle_path {$BACKEND_PATH:/api}/* {
        reverse_proxy {
            dynamic a {
                name {$BACKEND_DOMAIN}
                port {$BACKEND_PORT}
                refresh 1s
                dial_timeout 30s
                versions ipv4 ipv6
            }
            import lb_settings
            import passive_health_checks
            header_up Host {upstream_hostport}
        }
    }

    # Default: Proxy everything else to Frontend
    reverse_proxy {
        dynamic a {
            name {$FRONTEND_DOMAIN}
            port {$FRONTEND_PORT}
            refresh 1s
            dial_timeout 30s
            versions ipv4 ipv6
        }
        import lb_settings
        import passive_health_checks
        header_up Host {upstream_hostport}
    }
}