# global options
{
	admin off
	persist_config off
	auto_https off
	log {
		format json
	}
	servers {
		trusted_proxies static private_ranges
	}
}

(lb_settings) {
	lb_policy round_robin
	lb_retries 100
	lb_try_duration 10s
	lb_try_interval 250ms
}

(passive_health_checks) {
	fail_duration 60s
	max_fails 300
	unhealthy_latency 5s
	unhealthy_request_count 200
}

# Bot protection snippets
(block_bad_bots) {
	@bad_bots {
		header User-Agent *sqlmap*
		header User-Agent *nikto*
		header User-Agent *masscan*
		header User-Agent *nmap*
		header User-Agent *ZmEu*
		header User-Agent *scrapy*
	}
	respond @bad_bots 403
}

(block_scanner_paths) {
	@scanner_paths {
		path /wp-admin/* /wp-login.php /xmlrpc.php
		path /.env /config.php /phpmyadmin/*
		path /.git/* /backup/* /admin.php
	}
	respond @scanner_paths 404
}

(security_headers) {
	header {
		X-Content-Type-Options nosniff
		X-Frame-Options DENY
		X-XSS-Protection "1; mode=block"
		Referrer-Policy strict-origin-when-cross-origin
		-Server
	}
}

:{$PORT} {
	log {
		format json
	}

	# Apply global bot protection
	import block_bad_bots
	import block_scanner_paths
	import security_headers

	# OAuth2 paths - STRICT rate limiting (authentication endpoints)
	handle /oauth2/* {
		rate_limit {
			zone oauth {
				key {remote_host}
				events 10
				window 1m
			}
		}
		reverse_proxy {
			dynamic a {
				name {$BACKEND_DOMAIN}
				port {$BACKEND_PORT}
				refresh 1s
				dial_timeout 30s
				versions ipv4 ipv6
			}
			import lb_settings
			import passive_health_checks
			header_up Host {upstream_hostport}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
		}
	}

	# OAuth2 callback - STRICT rate limiting
	handle /login/oauth2/* {
		rate_limit {
			zone login {
				key {remote_host}
				events 15
				window 2m
			}
		}
		reverse_proxy {
			dynamic a {
				name {$BACKEND_DOMAIN}
				port {$BACKEND_PORT}
				refresh 1s
				dial_timeout 30s
				versions ipv4 ipv6
			}
			import lb_settings
			import passive_health_checks
			header_up Host {upstream_hostport}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
		}
	}

	# API endpoints - MODERATE rate limiting
	handle_path {$BACKEND_PATH:/api}/* {
		rate_limit {
			zone api {
				key {remote_host}
				events 100
				window 1m
			}
		}
		reverse_proxy {
			dynamic a {
				name {$BACKEND_DOMAIN}
				port {$BACKEND_PORT}
				refresh 1s
				dial_timeout 30s
				versions ipv4 ipv6
			}
			import lb_settings
			import passive_health_checks
			header_up Host {upstream_hostport}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
		}
	}

	# Frontend - LENIENT rate limiting
	reverse_proxy {
		rate_limit {
			zone frontend {
				key {remote_host}
				events 200
				window 1m
			}
		}
		dynamic a {
			name {$FRONTEND_DOMAIN}
			port {$FRONTEND_PORT}
			refresh 1s
			dial_timeout 30s
			versions ipv4 ipv6
		}
		import lb_settings
		import passive_health_checks
		header_up Host {upstream_hostport}
	}
}