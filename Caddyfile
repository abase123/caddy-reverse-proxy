{
    admin off
    persist_config off
    auto_https off
    
    # Global directive ordering
    order rate_limit before reverse_proxy
    order maxmind_geolocation before respond

    log {
        format json 
    }

    # SERVER OPTIONS
    # This is the most important part for Railway. 
    # It tells Caddy to trust Railway's internal network so it can 
    # find your actual Scandinavian IP address.
    servers {
        trusted_proxies static private_ranges 10.0.0.0/8
    }
}

# --- SNIPPETS ---

(lb_settings) {
    lb_policy round_robin
    lb_retries 100
    lb_try_duration 10s
    lb_try_interval 250ms
}

(passive_health_checks) {
    fail_duration 60s
    max_fails 300
    unhealthy_latency 5s
    unhealthy_request_count 200
}

(geo_block_scandinavia) {
    @blocked_geo {
        # Match if the IP is NOT from Scandinavia
        not maxmind_geolocation {
            db_path "/usr/share/GeoIP/GeoLite2-Country.mmdb"
            allow_countries NO SE DK FI IS
        }
        # DO NOT block Railway's internal health checks or private traffic
        not remote_ip private_ranges
    }
    respond @blocked_geo "Access denied - this service is only available in Scandinavia" 403
}

(rate_limiting) {
    rate_limit {
        # General requests - 100/min
        zone general {
            key {client_ip}
            events 100
            window 1m
        }
        # API requests - 30/min
        zone api {
            match {
                path /api/*
            }
            key {client_ip}
            events 30
            window 1m
        }
        # Auth requests - 10/min
        zone auth {
            match {
                path /oauth2/* /login/*
            }
            key {client_ip}
            events 10
            window 1m
        }
        log_key
        jitter 0.2
    }
}

# --- SITE BLOCK ---

:{$PORT} {
    log {
        format json
    }

    # 1. DEBUG ENDPOINT 
    # Use this to verify Caddy sees your real IP. Visit /debug/ip
    handle /debug/ip {
        respond "Real Client IP: {client_ip}" 200
    }

    # 2. SECURITY & LIMITING
    # Apply geo-blocking to everything EXCEPT the debug path
    @not_debug not path /debug/ip
    handle @not_debug {
        import geo_block_scandinavia
    }
    
    # Apply the rate limits
    import rate_limiting

    # 3. ROUTING (Specific to General)

    # OAuth2 Logic
    handle /oauth2/* {
        reverse_proxy {
            dynamic a {
                name {$BACKEND_DOMAIN}
                port {$BACKEND_PORT}
                refresh 1s
                dial_timeout 30s
            }
            import lb_settings
            import passive_health_checks
            header_up Host {upstream_hostport}
        }
    }

    handle /login/oauth2/* {
        reverse_proxy {
            dynamic a {
                name {$BACKEND_DOMAIN}
                port {$BACKEND_PORT}
                refresh 1s
                dial_timeout 30s
            }
            import lb_settings
            import passive_health_checks
            header_up Host {upstream_hostport}
        }
    }

    # API Logic (strips /api prefix)
    handle_path {$BACKEND_PATH:/api}/* {
        reverse_proxy {
            dynamic a {
                name {$BACKEND_DOMAIN}
                port {$BACKEND_PORT}
                refresh 1s
                dial_timeout 30s
            }
            import lb_settings
            import passive_health_checks
            header_up Host {upstream_hostport}
        }
    }

    # FALLBACK (Everything else goes to Frontend)
    handle /* {
        reverse_proxy {
            dynamic a {
                name {$FRONTEND_DOMAIN}
                port {$FRONTEND_PORT}
                refresh 1s
                dial_timeout 30s
            }
            import lb_settings
            import passive_health_checks
            header_up Host {upstream_hostport}
        }
    }
}